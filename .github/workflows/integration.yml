name: Integration Test

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

jobs:
  # Job 1: Build Reagle binary
  build:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C target-cpu=native"
      CARGO_PROFILE_RELEASE_LTO: "thin"
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            Rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Reagle
        working-directory: Rust
        run: cargo build --release

      - name: Upload Reagle binary
        uses: actions/upload-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/reagle
          retention-days: 1

  # Job 2: Prepare test data (runs in parallel with build)
  prepare-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl

      - name: Cache test data
        id: cache-data
        uses: actions/cache@v4
        with:
          path: Rust/tests/data/
          key: test-data-hgdp1kg-chr22-v2

      - name: Prepare test data
        if: steps.cache-data.outputs.cache-hit != 'true'
        working-directory: Rust
        run: python3 tests/integration_test.py prepare

      - name: Upload prepared data
        uses: actions/upload-artifact@v4
        with:
          name: test-data
          path: |
            Rust/tests/data/ref.vcf.gz
            Rust/tests/data/ref.vcf.gz.csi
            Rust/tests/data/truth.vcf.gz
            Rust/tests/data/truth.vcf.gz.csi
            Rust/tests/data/input.vcf.gz
            Rust/tests/data/input.vcf.gz.csi
            Rust/tests/data/beagle.jar
            Rust/tests/data/train_samples.txt
            Rust/tests/data/test_samples.txt
          retention-days: 1

  # Job 2b: Prepare profiling data (first 5% of chr22)
  prepare-profile-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl

      - name: Cache profiling data
        id: cache-profile-data
        uses: actions/cache@v4
        with:
          path: Rust/tests/data/
          key: test-data-hgdp1kg-chr22-profile5-v2

      - name: Prepare profiling data
        if: steps.cache-profile-data.outputs.cache-hit != 'true'
        working-directory: Rust
        run: python3 tests/integration_test.py prepare-profile

      - name: Upload prepared profiling data
        uses: actions/upload-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: |
            Rust/tests/data/ref.vcf.gz
            Rust/tests/data/ref.vcf.gz.csi
            Rust/tests/data/truth.vcf.gz
            Rust/tests/data/truth.vcf.gz.csi
            Rust/tests/data/input.vcf.gz
            Rust/tests/data/input.vcf.gz.csi
            Rust/tests/data/beagle.jar
            Rust/tests/data/train_samples.txt
            Rust/tests/data/test_samples.txt
          retention-days: 1

  # Job 3: Run Beagle imputation (depends on prepare-data)
  impute-beagle:
    runs-on: ubuntu-latest
    needs: prepare-data
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix openjdk-17-jre

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: Rust/tests/data/

      - name: Run Beagle imputation
        working-directory: Rust
        run: python3 tests/integration_test.py beagle

      - name: Upload Beagle results
        uses: actions/upload-artifact@v4
        with:
          name: beagle-results
          path: |
            Rust/tests/data/beagle_imputed.vcf.gz
            Rust/tests/data/beagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 3b: Run Beagle imputation (profile 5% of chr22)
  impute-beagle-profile:
    runs-on: ubuntu-latest
    needs: prepare-profile-data
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix openjdk-17-jre

      - name: Download prepared profiling data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: Rust/tests/data/

      - name: Run Beagle imputation (profile)
        working-directory: Rust
        run: python3 tests/integration_test.py beagle

      - name: Upload Beagle results (profile)
        uses: actions/upload-artifact@v4
        with:
          name: beagle-results-chr22-5pct
          path: |
            Rust/tests/data/beagle_imputed.vcf.gz
            Rust/tests/data/beagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 4: Run Reagle imputation (depends on build and prepare-data)
  impute-reagle:
    runs-on: ubuntu-latest
    needs: [build, prepare-data]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/

      - name: Make Reagle executable
        run: chmod +x Rust/target/release/reagle

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: Rust/tests/data/

      - name: Run Reagle imputation
        working-directory: Rust
        run: python3 tests/integration_test.py reagle

      - name: Upload Reagle results
        uses: actions/upload-artifact@v4
        with:
          name: reagle-results
          path: |
            Rust/tests/data/reagle_imputed.vcf.gz
            Rust/tests/data/reagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 4b: Run Reagle imputation (profile 5% of chr22)
  impute-reagle-profile:
    runs-on: ubuntu-latest
    needs: [build, prepare-profile-data]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/

      - name: Make Reagle executable
        run: chmod +x Rust/target/release/reagle

      - name: Download prepared profiling data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: Rust/tests/data/

      - name: Run Reagle imputation (profile)
        working-directory: Rust
        run: python3 tests/integration_test.py reagle

      - name: Upload Reagle results (profile)
        uses: actions/upload-artifact@v4
        with:
          name: reagle-results-chr22-5pct
          path: |
            Rust/tests/data/reagle_imputed.vcf.gz
            Rust/tests/data/reagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 5: Calculate metrics (depends on both imputation jobs)
  analyze:
    runs-on: ubuntu-latest
    needs: [impute-beagle, impute-reagle]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: Rust/tests/data/

      - name: Download Beagle results
        uses: actions/download-artifact@v4
        with:
          name: beagle-results
          path: Rust/tests/data/

      - name: Download Reagle results
        uses: actions/download-artifact@v4
        with:
          name: reagle-results
          path: Rust/tests/data/

      - name: Calculate metrics
        working-directory: Rust
        run: python3 tests/integration_test.py metrics

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: imputation-metrics
          path: Rust/tests/data/*_metrics.txt
          retention-days: 30

  # Job 5b: Calculate metrics (profile 5% of chr22)
  analyze-chr22-5pct:
    runs-on: ubuntu-latest
    needs: [impute-beagle-profile, impute-reagle-profile]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools

      - name: Download prepared profiling data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: Rust/tests/data/

      - name: Download Beagle results (profile)
        uses: actions/download-artifact@v4
        with:
          name: beagle-results-chr22-5pct
          path: Rust/tests/data/

      - name: Download Reagle results (profile)
        uses: actions/download-artifact@v4
        with:
          name: reagle-results-chr22-5pct
          path: Rust/tests/data/

      - name: Calculate metrics (profile)
        working-directory: Rust
        run: python3 tests/integration_test.py metrics

      - name: Upload metrics (profile)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: imputation-metrics-chr22-5pct
          path: Rust/tests/data/*_metrics.txt
          retention-days: 30
