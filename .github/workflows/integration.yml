name: Integration Test

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

jobs:
  # Job 1: Build Reagle binary
  build:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-C target-cpu=native"
      CARGO_PROFILE_RELEASE_LTO: "thin"
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Reagle
        working-directory: .
        run: cargo build --release

      - name: Upload Reagle binary
        uses: actions/upload-artifact@v4
        with:
          name: reagle-binary
          path: target/release/reagle
          retention-days: 1

  # Job 2: Prepare test data (runs in parallel with build)
  prepare-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl

      - name: Cache test data
        id: cache-data
        uses: actions/cache@v4
        with:
          path: tests/data/
          key: test-data-hgdp1kg-chr22-v2

      - name: Prepare test data
        if: steps.cache-data.outputs.cache-hit != 'true'
        working-directory: .
        run: python3 tests/integration_test.py prepare

      - name: Upload prepared data
        uses: actions/upload-artifact@v4
        with:
          name: test-data
          path: |
            tests/data/ref.vcf.gz
            tests/data/ref.vcf.gz.csi
            tests/data/truth.vcf.gz
            tests/data/truth.vcf.gz.csi
            tests/data/input.vcf.gz
            tests/data/input.vcf.gz.csi
            tests/data/beagle.jar
            tests/data/train_samples.txt
            tests/data/test_samples.txt
          retention-days: 1

  # Job 2b: Prepare 5% chr22 data
  prepare-profile-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl

      - name: Cache 5% chr22 data
        id: cache-profile-data
        uses: actions/cache@v4
        with:
          path: tests/data/
          key: test-data-hgdp1kg-chr22-profile5-v2

      - name: Prepare 5% chr22 data
        if: steps.cache-profile-data.outputs.cache-hit != 'true'
        working-directory: .
        run: python3 tests/integration_test.py prepare-profile

      - name: Upload prepared 5% chr22 data
        uses: actions/upload-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: |
            tests/data/ref.vcf.gz
            tests/data/ref.vcf.gz.csi
            tests/data/truth.vcf.gz
            tests/data/truth.vcf.gz.csi
            tests/data/input.vcf.gz
            tests/data/input.vcf.gz.csi
            tests/data/beagle.jar
            tests/data/train_samples.txt
            tests/data/test_samples.txt
          retention-days: 1

  # Job 3: Run Beagle imputation (depends on prepare-data)
  impute-beagle:
    runs-on: ubuntu-latest
    needs: prepare-data
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix openjdk-17-jre

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: tests/data/

      - name: Run Beagle imputation
        working-directory: .
        run: python3 tests/integration_test.py beagle

      - name: Upload Beagle results
        uses: actions/upload-artifact@v4
        with:
          name: beagle-results
          path: |
            tests/data/beagle_imputed.vcf.gz
            tests/data/beagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 3b: Run Beagle imputation (5% of chr22)
  impute-beagle-profile:
    runs-on: ubuntu-latest
    needs: prepare-profile-data
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix openjdk-17-jre

      - name: Download prepared 5% chr22 data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: tests/data/

      - name: Run Beagle imputation (5% chr22)
        working-directory: .
        run: python3 tests/integration_test.py beagle

      - name: Upload Beagle results (5% chr22)
        uses: actions/upload-artifact@v4
        with:
          name: beagle-results-chr22-5pct
          path: |
            tests/data/beagle_imputed.vcf.gz
            tests/data/beagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 4: Run Reagle imputation (depends on build and prepare-data)
  impute-reagle:
    runs-on: ubuntu-latest
    needs: [build, prepare-data]
    outputs:
      retry_illegal_instruction: ${{ steps.reagle-run.outputs.illegal_instruction }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: target/release/

      - name: Make Reagle executable
        run: chmod +x target/release/reagle

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: tests/data/

      - name: Run Reagle imputation
        id: reagle-run
        working-directory: .
        run: |
          set -o pipefail
          log_path="$PWD/tests/data/reagle_imputation.log"
          python3 tests/integration_test.py reagle 2>&1 | tee "$log_path"
          status=${PIPESTATUS[0]}
          if grep -q "Illegal instruction" "$log_path" || [ "$status" -eq 132 ]; then
            echo "illegal_instruction=true" >> "$GITHUB_OUTPUT"
            echo "Retryable illegal instruction detected; leaving artifacts for retry."
            exit 0
          fi
          exit "$status"

      - name: Upload Reagle results
        uses: actions/upload-artifact@v4
        if: steps.reagle-run.outputs.illegal_instruction != 'true'
        with:
          name: reagle-results
          path: |
            tests/data/reagle_imputed.vcf.gz
            tests/data/reagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 4a: Retry Reagle imputation on a fresh runner if illegal instruction was detected
  impute-reagle-retry:
    runs-on: ubuntu-latest
    needs: [build, prepare-data, impute-reagle]
    if: needs.impute-reagle.outputs.retry_illegal_instruction == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: target/release/

      - name: Make Reagle executable
        run: chmod +x target/release/reagle

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: tests/data/

      - name: Run Reagle imputation (retry)
        working-directory: .
        run: python3 tests/integration_test.py reagle

      - name: Upload Reagle results (retry)
        uses: actions/upload-artifact@v4
        with:
          name: reagle-results
          path: |
            tests/data/reagle_imputed.vcf.gz
            tests/data/reagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 4b: Run Reagle imputation (5% of chr22)
  impute-reagle-profile:
    runs-on: ubuntu-latest
    needs: [build, prepare-profile-data]
    outputs:
      retry_illegal_instruction: ${{ steps.reagle-run.outputs.illegal_instruction }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: target/release/

      - name: Make Reagle executable
        run: chmod +x target/release/reagle

      - name: Download prepared 5% chr22 data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: tests/data/

      - name: Run Reagle imputation (5% chr22)
        id: reagle-run
        working-directory: .
        run: |
          set -o pipefail
          log_path="$PWD/tests/data/reagle_imputation.log"
          python3 tests/integration_test.py reagle 2>&1 | tee "$log_path"
          status=${PIPESTATUS[0]}
          if grep -q "Illegal instruction" "$log_path" || [ "$status" -eq 132 ]; then
            echo "illegal_instruction=true" >> "$GITHUB_OUTPUT"
            echo "Retryable illegal instruction detected; leaving artifacts for retry."
            exit 0
          fi
          exit "$status"

      - name: Upload Reagle results (5% chr22)
        uses: actions/upload-artifact@v4
        if: steps.reagle-run.outputs.illegal_instruction != 'true'
        with:
          name: reagle-results-chr22-5pct
          path: |
            tests/data/reagle_imputed.vcf.gz
            tests/data/reagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 4c: Retry Reagle imputation (5% chr22) on a fresh runner if illegal instruction was detected
  impute-reagle-profile-retry:
    runs-on: ubuntu-latest
    needs: [build, prepare-profile-data, impute-reagle-profile]
    if: needs.impute-reagle-profile.outputs.retry_illegal_instruction == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: target/release/

      - name: Make Reagle executable
        run: chmod +x target/release/reagle

      - name: Download prepared 5% chr22 data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: tests/data/

      - name: Run Reagle imputation (5% chr22 retry)
        working-directory: .
        run: python3 tests/integration_test.py reagle

      - name: Upload Reagle results (5% chr22 retry)
        uses: actions/upload-artifact@v4
        with:
          name: reagle-results-chr22-5pct
          path: |
            tests/data/reagle_imputed.vcf.gz
            tests/data/reagle_imputed.vcf.gz.csi
          retention-days: 1

  # Job 5: Calculate metrics (depends on both imputation jobs)
  analyze:
    runs-on: ubuntu-latest
    needs: [impute-beagle, impute-reagle, impute-reagle-retry]
    if: >-
      ${{
        always() &&
        needs.impute-beagle.result == 'success' &&
        (needs.impute-reagle.result == 'success' || needs.impute-reagle-retry.result == 'success')
      }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: test-data
          path: tests/data/

      - name: Download Beagle results
        uses: actions/download-artifact@v4
        with:
          name: beagle-results
          path: tests/data/

      - name: Download Reagle results
        uses: actions/download-artifact@v4
        with:
          name: reagle-results
          path: tests/data/

      - name: Calculate metrics
        working-directory: .
        run: python3 tests/integration_test.py metrics

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: imputation-metrics
          path: tests/data/*_metrics.txt
          retention-days: 30

  # Job 5b: Calculate metrics (5% of chr22)
  analyze-chr22-5pct:
    runs-on: ubuntu-latest
    needs: [impute-beagle-profile, impute-reagle-profile, impute-reagle-profile-retry]
    if: >-
      ${{
        always() &&
        needs.impute-beagle-profile.result == 'success' &&
        (needs.impute-reagle-profile.result == 'success' || needs.impute-reagle-profile-retry.result == 'success')
      }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools

      - name: Download prepared 5% chr22 data
        uses: actions/download-artifact@v4
        with:
          name: test-data-chr22-5pct
          path: tests/data/

      - name: Download Beagle results (5% chr22)
        uses: actions/download-artifact@v4
        with:
          name: beagle-results-chr22-5pct
          path: tests/data/

      - name: Download Reagle results (5% chr22)
        uses: actions/download-artifact@v4
        with:
          name: reagle-results-chr22-5pct
          path: tests/data/

      - name: Calculate metrics (5% chr22)
        working-directory: .
        run: python3 tests/integration_test.py metrics

      - name: Upload metrics (5% chr22)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: imputation-metrics-chr22-5pct
          path: tests/data/*_metrics.txt
          retention-days: 30
