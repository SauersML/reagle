name: Full Genome Nightly Test

# Runs full genome imputation benchmark (all chromosomes)
# Triggered: Nightly at 4 AM EST (9:00 UTC) or manual dispatch

on:
  schedule:
    # 4 AM EST = 9:00 UTC (EST is UTC-5)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      chromosomes:
        description: 'Chromosomes to test (comma-separated, e.g. "1,2,22" or "all")'
        required: false
        default: 'all'
      tools:
        description: 'Tools to run (comma-separated)'
        required: false
        default: 'beagle,reagle,impute5,minimac,glimpse'

jobs:
  # Job 1: Build Reagle binary
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            Rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Reagle
        working-directory: Rust
        run: cargo build --release

      - name: Upload Reagle binary
        uses: actions/upload-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/reagle
          retention-days: 7

  # Job 2: Prepare data for each chromosome (Run once per chromosome)
  prepare-data:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chromosome: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl

      - name: Cache chromosome data
        id: cache-data
        uses: actions/cache@v4
        with:
          path: Rust/tests/data_chr${{ matrix.chromosome }}/
          key: test-data-hgdp1kg-chr${{ matrix.chromosome }}-v5

      - name: Prepare chromosome ${{ matrix.chromosome }}
        if: steps.cache-data.outputs.cache-hit != 'true'
        working-directory: Rust
        run: python3 tests/integration_test.py prepare-chr ${{ matrix.chromosome }}

      - name: Upload chromosome data
        uses: actions/upload-artifact@v4
        with:
          name: data-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/
          retention-days: 7

  # Job 3: Run imputation for each tool on each chromosome
  # ISOLATION: Each tool/chromosome pair runs on a separate runner.
  # REUSE: Downloads prepared data from prepare-data job.
  impute:
    name: Impute ${{ matrix.tool }} chr${{ matrix.chromosome }}
    runs-on: ubuntu-latest
    needs: [build, prepare-data]
    strategy:
      fail-fast: false
      matrix:
        tool: [beagle, reagle, impute5, minimac, glimpse]
        chromosome: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl openjdk-17-jre

      - name: Download Reagle binary
        if: matrix.tool == 'reagle'
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/

      - name: Make Reagle executable
        if: matrix.tool == 'reagle'
        run: chmod +x Rust/target/release/reagle

      - name: Download chromosome data
        uses: actions/download-artifact@v4
        with:
          name: data-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/

      # Run ONLY the specific tool for this runner
      - name: Run ${{ matrix.tool }} on chr${{ matrix.chromosome }}
        working-directory: Rust
        run: |
          python3 tests/integration_test.py impute-chr ${{ matrix.chromosome }} \
            --tools ${{ matrix.tool }}

      - name: Upload imputation results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.tool }}-chr${{ matrix.chromosome }}
          path: |
            Rust/tests/data_chr${{ matrix.chromosome }}/${{ matrix.tool }}_imputed.vcf.gz
            Rust/tests/data_chr${{ matrix.chromosome }}/${{ matrix.tool }}_imputed.vcf.gz.csi
            Rust/tests/data_chr${{ matrix.chromosome }}/${{ matrix.tool }}_imputed.vcf.gz.tbi
          retention-days: 7

  # Job 4: Calculate metrics for each tool/chromosome
  analyze:
    name: Metrics ${{ matrix.tool }} chr${{ matrix.chromosome }}
    runs-on: ubuntu-latest
    needs: impute # (Indirectly needs prepare-data logic via data download)
    strategy:
      fail-fast: false
      matrix:
        tool: [beagle, reagle, impute5, minimac, glimpse]
        chromosome: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Download chromosome data (Ref/Truth)
        uses: actions/download-artifact@v4
        with:
          name: data-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/

      - name: Download imputation results
        uses: actions/download-artifact@v4
        with:
          name: results-${{ matrix.tool }}-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/

      - name: Calculate metrics for ${{ matrix.tool }} on chr${{ matrix.chromosome }}
        working-directory: Rust
        run: python3 tests/integration_test.py metrics-chr ${{ matrix.chromosome }}

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ matrix.tool }}-chr${{ matrix.chromosome }}
          path: |
            Rust/tests/data_chr${{ matrix.chromosome }}/*_metrics.txt
            Rust/tests/data_chr${{ matrix.chromosome }}/*_metrics.json
          retention-days: 30

  # Job 4: Aggregate all chromosome metrics
  summary:
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4

      - name: Download all metrics
        uses: actions/download-artifact@v4
        with:
          pattern: metrics-*
          path: Rust/tests/
          merge-multiple: true

      - name: Generate genome-wide summary
        working-directory: Rust
        run: python3 tests/integration_test.py summary

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: genome-wide-summary
          path: Rust/tests/*summary*.txt
          retention-days: 30
