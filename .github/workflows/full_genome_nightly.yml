name: Full Genome Nightly Test

# Runs full genome imputation benchmark (all chromosomes)
# Triggered: Nightly at 4 AM EST (9:00 UTC) or manual dispatch

on:
  schedule:
    # 4 AM EST = 9:00 UTC (EST is UTC-5)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      chromosomes:
        description: 'Chromosomes to test (comma-separated, e.g. "1,2,22" or "all")'
        required: false
        default: 'all'
      tools:
        description: 'Tools to run (comma-separated)'
        required: false
        default: 'beagle,reagle'

jobs:
  # Job 1: Build Reagle binary
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            Rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Reagle
        working-directory: Rust
        run: cargo build --release

      - name: Upload Reagle binary
        uses: actions/upload-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/reagle
          retention-days: 7

  # Job 2: Prepare and run imputation for each chromosome
  impute:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        chromosome: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix curl openjdk-17-jre

      - name: Download Reagle binary
        uses: actions/download-artifact@v4
        with:
          name: reagle-binary
          path: Rust/target/release/

      - name: Make Reagle executable
        run: chmod +x Rust/target/release/reagle

      - name: Cache chromosome data
        id: cache-data
        uses: actions/cache@v4
        with:
          path: Rust/tests/data_chr${{ matrix.chromosome }}/
          key: test-data-hgdp1kg-chr${{ matrix.chromosome }}-v4

      # Use Python script for all stages
      - name: Prepare chromosome ${{ matrix.chromosome }}
        if: steps.cache-data.outputs.cache-hit != 'true'
        working-directory: Rust
        run: python3 tests/integration_test.py prepare-chr ${{ matrix.chromosome }}

      - name: Run imputation on chr${{ matrix.chromosome }}
        working-directory: Rust
        run: |
          python3 tests/integration_test.py impute-chr ${{ matrix.chromosome }} \
            --tools ${{ inputs.tools || 'beagle,reagle' }}

      - name: Upload chromosome data
        uses: actions/upload-artifact@v4
        with:
          name: data-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/
          retention-days: 7

  # Job 3: Calculate metrics for each chromosome
  analyze:
    runs-on: ubuntu-latest
    needs: impute
    strategy:
      fail-fast: false
      matrix:
        chromosome: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools

      - name: Download chromosome data
        uses: actions/download-artifact@v4
        with:
          name: data-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/

      - name: Calculate metrics for chr${{ matrix.chromosome }}
        working-directory: Rust
        run: python3 tests/integration_test.py metrics-chr ${{ matrix.chromosome }}

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics-chr${{ matrix.chromosome }}
          path: Rust/tests/data_chr${{ matrix.chromosome }}/*_metrics.txt
          retention-days: 30

  # Job 4: Aggregate all chromosome metrics
  summary:
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4

      - name: Download all metrics
        uses: actions/download-artifact@v4
        with:
          pattern: metrics-chr*
          path: Rust/tests/
          merge-multiple: true

      - name: Generate genome-wide summary
        working-directory: Rust
        run: python3 tests/integration_test.py summary

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: genome-wide-summary
          path: Rust/tests/*summary*.txt
          retention-days: 30
